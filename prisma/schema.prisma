generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// *
/// * ===================== Chat =====================
model ChatSession {
  id        String        @id @default(cuid())
  userId    String
  title     String        @default("新的对话")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  pinned    Boolean       @default(false)
  messages  ChatMessage[]

  @@index([userId, pinned, updatedAt])
  @@index([userId, updatedAt])
}

model ChatMessage {
  id            String      @id @default(cuid())
  chatSessionId String
  role          String
  content       String
  createdAt     DateTime    @default(now())
  chatSession   ChatSession @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)

  @@index([chatSessionId, createdAt])
}

/// *
/// * ===================== Billing / Plans =====================
model UserEntitlement {
  userId                    String    @unique
  plan                      String    @default("basic")
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  stripeCustomerId          String?
  stripeStatus              String?
  stripeSubId               String?
  id                        String    @id @default(cuid())
  canSeeSuspiciousSentences Boolean   @default(false)
  chatPerDay                Int?
  detectorWordsPerWeek      Int?
  noteSecondsPerWeek        Int?
  unlimited                 Boolean   @default(false)
  cancelAtPeriodEnd         Boolean?  @default(false)
  currentPeriodEnd          DateTime?
  dailyUsageKey             String?
  unlimitedSource           String?
  weeklyUsageKey            String?
  usedChatCountToday        Int       @default(0)
  usedDetectorWordsThisWeek Int       @default(0)
  usedNoteSecondsThisWeek   Int       @default(0)
}

model ProcessedStripeEvent {
  id        String   @id @default(cuid())
  eventId   String   @unique
  type      String
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model GiftCode {
  code        String               @id
  isActive    Boolean              @default(true)
  maxUses     Int?
  usedCount   Int                  @default(0)
  createdAt   DateTime             @default(now())
  redemptions GiftCodeRedemption[]

  @@index([isActive])
}

model GiftCodeRedemption {
  id        String   @id @default(cuid())
  code      String
  userId    String
  createdAt DateTime @default(now())
  giftCode  GiftCode @relation(fields: [code], references: [code])

  @@unique([code, userId])
  @@index([userId])
  @@index([code, createdAt])
}

model UsageEvent {
  id        String   @id @default(cuid())
  userId    String
  type      String
  amount    Int
  createdAt DateTime @default(now())

  @@index([userId, type, createdAt])
  @@index([createdAt])
}

/// *
/// * ===================== AI Note =====================
model AiNoteSession {
  id          String              @id @default(cuid())
  userId      String
  createdAt   DateTime            @default(now())
  aiNoteJobId String?
  chunks      AiNoteChunk[]
  job         AiNoteJob?          @relation(fields: [aiNoteJobId], references: [id])
  summaries   AiNoteSummaryPart[]
  transcripts AiNoteTranscript[]

  @@index([userId, createdAt])
}

model AiNoteChunk {
  id         String        @id @default(cuid())
  noteId     String
  chunkIndex Int
  mime       String
  size       Int
  data       Bytes
  createdAt  DateTime      @default(now())
  session    AiNoteSession @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([noteId, chunkIndex])
  @@index([noteId])
}

model AiNoteTranscript {
  id         String        @id @default(cuid())
  noteId     String
  chunkIndex Int
  text       String
  createdAt  DateTime      @default(now())
  session    AiNoteSession @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([noteId, chunkIndex])
  @@index([noteId])
}

model AiNoteSummaryPart {
  id        String        @id @default(cuid())
  noteId    String
  partIndex Int
  text      String
  createdAt DateTime      @default(now())
  session   AiNoteSession @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([noteId, partIndex])
  @@index([noteId])
}

model AiNoteJob {
  id             String          @id @default(cuid())
  noteId         String          @unique
  userId         String
  stage          String          @default("prep")
  progress       Int             @default(0)
  error          String?
  updatedAt      DateTime        @updatedAt
  createdAt      DateTime        @default(now())
  asrNextIndex   Int             @default(0)
  llmNextPart    Int             @default(0)
  llmPartsTotal  Int             @default(0)
  noteMarkdown   String?
  secondsBilled  Int?
  segmentTimeSec Int             @default(300)
  segmentsTotal  Int             @default(0)
  lockExpiresAt  DateTime?
  lockedAt       DateTime?
  lockedBy       String?
  AiNoteSession  AiNoteSession[]

  @@index([noteId])
  @@index([lockedBy])
}
